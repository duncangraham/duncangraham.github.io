---
layout: post
title:  "team migration"
type: "experiment"
date:   2014-01-10 13:47:00
---

<style>

#relocations {
  margin-top: -3em;
}

#relocations svg {
  padding-bottom: 2em;
  margin-top: -2em;
}

#mc_embed_signup {
display: none;
}

.flexbox {
  margin: 3.5em 0em;
  padding: 1em;
}


#meta {
  position: absolute;
}

.site {
}

.d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}

.background {
  fill: none;
  pointer-events: all;
}

#states {
  fill: #CCC;
}

#state-borders {
  fill: none;
  stroke: #fff;
  stroke-width: 1.5px;
  stroke-linejoin: round;
  stroke-linecap: round;
  pointer-events: none;
}

.space_big {
  margin: 2em 0em;
}

.hide {
  display: none;
}

circle {
  fill: #333;
}

.arrow {
  fill: blue;
}

.link {
  fill: none;
  stroke: red;
  stroke-width: 1.5px;
  -webkit-transition: stroke-width .2s;
  -moz-transition: stroke-width .2s;
  -o-transition: stroke-width .2s;
  transition: stroke-width .2s;
}

.link:hover {
  stroke-width: 3px;
  cursor: none;
}

.link.nfl {
  stroke: #313AFF;
}

.arrow.nfl {
  fill: #313AFF;
}

.link.nba {
  stroke: #9224FF;
}

.arrow.nba {
  fill: #9224FF;
}

.link.mlb {
  stroke: #24A1FF;
}

.arrow.mlb {
  fill: #24A1FF;
}

.link.inactive {

}

#tooltip {
  position: absolute;
  background-color: #FFF;
  box-shadow: 0px 0px 2px #666;
  padding: 0em 1em;
  font-size: 0.8em;
  top:0;
  left: 0;
  display:none;
}

.label.nfl {
  color: #313AFF;
}

.label.nba {
  color: #9224FF;
}

.label.mlb {
  color: #24A1FF;
}

.axis path, .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
}

</style>
</div> <!-- close entry-spacing div, maybe bring it onto this page? would make it more extensible -->
<div id="relocations"></div>
<div id='tooltip'>
  <p class="no-pad">Departed <strong class="cityDepart"></strong>, <strong class="stateDepart"></strong> as the <strong class="nameDepart"></strong></p>
  <p class="no-pad">Arrived <strong class="cityArrive"></strong>, <strong class="stateArrive"></strong> as the <strong class="nameArrive"></strong></p>
  <span> Year: <strong class="year nopad"></strong> | Sport: <strong class="sport"></strong></span>
  
</div>
<div class="bottom space-top">
<!--   <div class="entry-content content-spacing">
    <ul class="flexbox flex_space-between space-top">
                    <li class="sort-opt font-dark">
                      
                    </li>
                    <li class="sort-opt">
                      <h2 class="label nfl font-large" data-sport="nfl">NFL</h2>
                    </li>
                    <li class="sort-opt">
                      <h2 class="label nba font-large" data-sport="nba">NBA</h2>
                    </li>
                    <li class="sort-opt">
                      <h2 class="label mlb font-large" data-sport="mlb">MLB</h2>
                    </li>
                    <li class="sort-opt font-dark">
                      <h2 class="label replay font-large">REPLAY</h2>
                    </li>
                </ul>  
  </div> -->
</div>
<script src="{{ root_path }}js/d3.min.js"></script>
<script src="{{ root_path }}js/topojson.v1.min.js"></script>
<script>

$('.label').hover(function(){

  var sport = $(this).data('sport');

  if ( sport == 'nba' ) {
    $('.link.nfl, .link.mlb, .arrow.nfl, .arrow.mlb').animate({opacity: '.05'}, 200);
  } else if ( sport == 'nfl' ) {
    $('.link.nba, .link.mlb, .arrow.nba, .arrow.mlb').animate({opacity: '.05'}, 200);
  } else {
    $('.link.nfl, .link.nba, .arrow.nfl, .arrow.nba').animate({opacity: '.05'}, 200);
  }

},function(){
  $('.link, .arrow').animate({opacity: '1'}, 200);
});

var width =  document.body.offsetWidth || 960,
    height = 650,
    centered,
    projection = d3.geo.albersUsa()
                   .scale(1070)
                   .translate([width / 2, height / 2]),
    path = d3.geo
             .path()
             .projection(projection),
    svg = d3.select("#relocations")
            .append("svg")
            .attr("width", width)
            .attr("height", height),
    g = svg.append("g"),
    tooltip = $("#tooltip");



d3.json("/json/us.json", function(error, us) {
  g.append("g")
      .attr("id", "states")
    .selectAll("path")
      .data(topojson.feature(us, us.objects.states).features)
    .enter().append("path")
      .attr("d", path);

  g.append("path")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      .attr("id", "state-borders")
      .attr("d", path);


  d3.json("/json/migrations.json", function(error, data) {
      var m = data.migrations,
          year = 1900,
          yearDiv = $('#year');
  
      var x = d3.time.scale()
                     .domain([new Date(1900, 7, 1), new Date(2014, 7, 1)])
                     .rangeRound([0, width*.8]);
      var xAxis = d3.svg.axis()
                    .scale(x)
                    .orient('bottom')
                    .ticks(d3.time.years, 5)
                    .tickFormat(d3.time.format('%Y'))
                    .tickSize(4)
                    .tickPadding(8);

      svg.append('g')
        .attr('class', 'x axis')
        .attr('transform', 'translate(' + width/10 + ', ' + height + ')')
        .call(xAxis);

    svg.append("g").attr('id', 'departPoints')
      .selectAll('circle')
       .data(m)
       .enter()
        .append('circle')
        .attr('r', 2)
        .attr("transform", function(d) {return "translate(" + projection([d.left.coords[0],d.left.coords[1]]) + ")";});

    svg.append("g").attr('id', 'arrivePoints')
      .selectAll('circle')
       .data(m)
       .enter()
        .append('circle')
        .attr('r', 2)
        .attr("transform", function(d) {return "translate(" + projection([d.arrived.coords[0],d.arrived.coords[1]]) + ")";});

    var groups = svg.append("g").selectAll("path")
                    .data(m)
                    .enter()
                    .append('g');

    var paths = groups.append("path")
                     .attr("d", function(d) {
                        var start = projection(d.left.coords),
                            end = projection(d.arrived.coords);

                        var dx = start[0] - end[0],
                            dy = start[1] - end[1],
                            dr = Math.sqrt(dx * dx + dy * dy);

                        return "M" + start[0] + "," + start[1] + "A" + dr + "," + dr + " 0 0,1 " + end[0] + "," + end[1];
                     })
                     .attr('class', function(d){
                      if( d.sport === 'NBA' ) {
                        return 'link nba'
                      } else if ( d.sport === 'NFL' ) {
                        return 'link nfl'
                      } else {
                        return 'link mlb'
                      }
                     })
                     .each(transition);
      var rects = groups.append("rect")
                        .attr("x", function(d) { 
                          var year = new Date(d.year, 1, 1);
                          return x(year)+width/10; })
                        .attr("width", "10px")
                        .attr("y", height/2-10)
                        .attr("height", "10px")
                        .style("fill", function(d) {
                          if( d.sport === 'NBA' ) {
                            return '#9224FF'
                          } else if ( d.sport === 'NFL' ) {
                            return '#313AFF'
                          } else {
                            return '#24A1FF'
                          }
                        });

      groups.append("path")
       .attr('d', 'M 0,0 7,3.5 0,7 1.5,3.5 ')
       .attr('class', function(d){
        if( d.sport === 'NBA' ) {
          return 'arrow nba'
        } else if ( d.sport === 'NFL' ) {
          return 'arrow nfl'
        } else {
          return 'arrow mlb'
        }
       })
       .attr('style', 'visibility: hidden')
       .attr("transform", function(d) {return "translate(" + projection([d.left.coords[0],d.left.coords[1]]) + ")";})
       .each(transitionArrows);

      function transition() {
        var totalLength = this.getTotalLength();
        d3.select(this).attr("stroke-dasharray", totalLength + " " + totalLength)
                       .attr("stroke-dashoffset", totalLength);
        d3.select(this).transition()
            .duration(1000)
            .delay(function(d,i) {
                return ((d.year-1900)*100);
            })
            .ease("ease-out")
            .attr("stroke-dashoffset", 0);
      }

     function transitionArrows () {
      d3.select(this).transition()
                     .duration(1000)
                     .ease("ease-out")
                     .delay(function(d,i) { return (( d.year-1900 )*100); })
                     .attrTween("transform", translateAlong )
                     .attr('style', 'visibility: visible');
     }

     // Returns an attrTween for translating along the specified path element.
     function translateAlong(pathNode) {
      var pathNode = this.parentNode.getElementsByTagName("path")[0];
      var l1 = pathNode.getTotalLength()-.01,
          l2 = pathNode.getTotalLength(),
          t0 = 0
          
      return function(t) {
           var p0 = pathNode.getPointAtLength(t0 * l1);//previous point
           var p = pathNode.getPointAtLength(t * l2);////current point
           var angle = Math.atan2(p.y - p0.y, p.x - p0.x) * 180 / Math.PI;//angle for tangent
           t0 = t;
           var centerX = p.x - 7,
               centerY = p.y - 3.5;
           return "translate(" + centerX + "," + centerY + ")rotate(" + angle + " 7" + " 3.5" +")";
      };
     }
  });

});
</script>



<!--
footnotes

things that helped
what's .data()? http://stackoverflow.com/questions/9481497/understanding-how-d3-js-binds-data-to-nodes

https://github.com/mbostock/d3/wiki/Geo-Paths
http://bl.ocks.org/enoex/6201948
https://groups.google.com/forum/#!topic/d3-js/MLZX1AbS7-Y
http://fiddle.jshell.net/RnNsE/2/

-->
