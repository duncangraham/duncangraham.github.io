<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Duncan Dealer Locator</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='jquery.js'></script>
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.js'></script>
<!-- <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script> -->
<link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.css' rel='stylesheet' />
<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>

<style>
  body { margin:0; padding:0; font-size: 12px; line-height: 14px; background: #fff url(brushed.png) fixed;
   font-family: 'Lato', sans-serif;}
  #map { position:absolute; top:0; bottom:0; width:100%; }
  /* Adjustments to account for mapbox.css box-sizing rules */
.leaflet-control-zoomslider-knob { width:14px; height:6px; }
.leaflet-container .leaflet-control-zoomslider-body {
  -webkit-box-sizing:content-box;
     -moz-box-sizing:content-box;
          box-sizing:content-box;
  }
 /* .leaflet-control-attribution a {display:none;}*/
  .leaflet-popup-content-wrapper {

  }

</style>
<style>
  #rightpane {
    position:absolute;
    width:230px;
    top:10px;
    right:10px;
    border-radius:2px;
    max-height:390px;
    overflow:auto;
    }
  .info {
    background:rgba(255,255,255,.9);
    width:230px;
    border-radius:2px;
    max-height:300px;
    overflow:auto;
    }
    .info .item, #rightpane b, #rightpane i {
      display:block;
      border-bottom:1px solid #eee;
      padding:8px;
      text-decoration:none;
      }
      .info .item small { color:#888; }
      .info .item:hover,
      .info .item.active { background:#fff; }
      .info .item:last-child { border-bottom:none; }
    #rightpane b {
    background:rgba(255,255,255,1); font-size: 14px; padding: 12px;
    }
  #rightpane i {background:rgba(255,255,255,1); font-size: 10px;}
</style>
<div id='map'></div>
<div id='rightpane'>
    <b>Duncan Dealer Locations</b>
    <div id='info' class='info'></div>
    <i>(locations are sorted by proximity to center of map as you drag or search)</i></div>

<!-- <ul id='marker-list'></ul> -->
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-zoomslider/v0.7.0/L.Control.Zoomslider.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-zoomslider/v0.7.0/L.Control.Zoomslider.css' rel='stylesheet' />
<script>
L.mapbox.accessToken = 'pk.eyJ1IjoibWljaGFlbHBydWVzcyIsImEiOiJuYlJ3UmU0In0.4HQ6eyFGIcy8qb7PbhrYrw ';
  var map = L.mapbox.map('map', 'michaelpruess.kd35gg1m', {zoomControl: false})
    .addControl(L.mapbox.geocoderControl('mapbox.places-v1', {
        autocomplete: true,keepOpen: true
    }));

L.control.zoomslider().addTo(map);

var features = L.mapbox
  .featureLayer('michaelpruess.kd35gg1m')
  .addTo(map)
  .on('ready', function(){
    features.eachLayer(function(layer) {
      var feature = layer.feature;
      var site = feature.properties.Website;
      var ttp = site.indexOf('ttp');
      if(ttp!=1) {site = 'http://'+site;}

      // here you call `bindPopup` with a string of HTML you create - the feature
      // properties declared above are available under `layer.feature.properties`
      var popupContent =  '<b>'+feature.properties.title+'</b><br />'+feature.properties.Address+', '+feature.properties.City+', '+feature.properties.State+' '+feature.properties.Zip+'<br />'+feature.properties.Phone+'<br /><a href="'+site+'">'+feature.properties.Website+'</a>';
      layer.bindPopup(popupContent);
    });
  });

map.featureLayer.on('ready', function(){
  console.log('works')

  map.featureLayer.eachLayer(function(layer) {
    var feature = layer.feature;
    var site = feature.properties.Website;
    var ttp = site.indexOf('ttp');
    if(ttp!=1) {site = 'http://'+site;}

    // here you call `bindPopup` with a string of HTML you create - the feature
    // properties declared above are available under `layer.feature.properties`
    var popupContent =  '<b>'+feature.properties.title+'</b><br />'+feature.properties.Address+', '+feature.properties.City+', '+feature.properties.State+' '+feature.properties.Zip+'<br />'+feature.properties.Phone+'<br /><a href="'+site+'">'+feature.properties.Website+'</a>';
    layer.bindPopup(popupContent);
  });
});

/*
features.on('layeradd', function(e) {
    var marker = e.layer,
    feature = marker.feature;

    // Create custom popup content
    var site = feature.properties.Website;
    var ttp = site.indexOf('ttp');
    if(ttp!=1) {site = 'http://'+site;}
    var popupContent =  '<b>'+feature.properties.title+'</b><br />'+feature.properties.Address+', '+feature.properties.City+', '+feature.properties.State+' '+feature.properties.Zip+'<br />'+feature.properties.Phone+'<br /><a href="'+site+'">'+feature.properties.Website+'</a>';

    marker.bindPopup(popupContent);
});
*/

map.on("moveend", populateListing);

features.on('ready', populateListing);

function populateListing() {

    // Clear out the listing container first.
    info.innerHTML = '';
    var listings = [];

    // Build a listing of markers
    features.eachLayer(function(marker) {

        // Center coordinates.
        var home = map.getCenter();
        var metresToMiles = 0.000621371192;
        var distance = (metresToMiles * home.distanceTo(marker.getLatLng())).toFixed(1);

        var link = document.createElement('a');
        link.className = 'item';
        link.href = '#';
        link.setAttribute('data-distance', distance);

        // Populate content from each markers object.
        link.innerHTML = marker.feature.properties.title +
            '<br /><small>' + distance + ' mi. from map center</small>';

        link.onclick = function() {
            if (/active/.test(this.className)) {
                this.className = this.className.replace(/active/, '').replace(/\s\s*$/, '');
            } else {
                var siblings = info.getElementsByTagName('a');
                for (var i = 0; i < siblings.length; i++) {
                    siblings[i].className = siblings[i].className
                    .replace(/active/, '').replace(/\s\s*$/, '');
                };
                this.className += ' active';

                // When a menu item is clicked, animate the map to center
                // its associated marker and open its popup.
                map.panTo(marker.getLatLng());

                marker.openPopup();

            }
            return false;
        };

        listings.push(link);
    });

    // Sort the listing based on the
    // assigned attribute, 'data-listing'
    listings.sort(function(a, b) {
        return a.getAttribute('data-distance') - b.getAttribute('data-distance');
    });

    listings.forEach(function(listing) {
        info.appendChild(listing);
    });

}
</script>

</body>
</html>
