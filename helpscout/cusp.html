
<!DOCTYPE html>
<html>
<head>
  <title>CUSP Map Pittsburgh</title>
  <meta name='description' content='CUSP Map Pittsburgh is an interactive map designed to help you visualize how climate change is projected to impact Pittsburgh.'>
  <meta name='keywords' content='cusp, map, pitsburgh, pennsylvania, climate change'>
  <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.css' rel='stylesheet' />
  <link href='Pittsburgh_styles2.css' rel='stylesheet' type='text/css' />
  <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
 </head>
 <body id='cuspbody' class='nosidebar'>

<div id='cusp-banner'>
    <!-- <img style='vertical-align:top' src='CUSP_Pitt.jpg' id='logo'> -->
    <a href="http://www.cuspproject.org/" target="_blank"><img style='vertical-align:top' src='CUSP_Pitt.jpg' id='logo'></a>
    <span id="beta">BETA</span>
<!--     <a href="http://www.cuspproject.org/"id="cusp_button" title="Learn more about the entire CUSP project.">CUSP PROJECT</a> -->
    <a href='http://cuspmap.org/about/' id="about_button">ABOUT</a>
    <a href='#' id="transportation_button" title="Click to take a guided tour through the map to learn more about how climate change may impact transportation infrastructure in our city.">TRANSPORTATION STORY</a>
    <a href='#' id="wastewater_button" title="Click to take a guided tour through the map to learn more about how climate change may impact wastewater infrastructure in our city.">WET WEATHER STORY</a>
<!--     <a href='#' id="energy_button" title="Click to take a guided tour through the map to learn more about how climate change may impact energy infrastructure in our city.">ENERGY (coming soon)</a> -->
</div>
<!-- <div id='story-banner'>
    <a href='#' id="wastewater_button" title="Click to take a guided tour through the map to learn more about how climate change may impact wastewater infrastructure in our city.">STORMWATER AND CLIMATE CHANGE STORY</a>
    <a href='#' id="story_button2">MORE STORIES TO COME...</a>
</div> -->
<ul id='map-ui'></ul>
<div id='map' class="dark"></div>

<!-- 'add point' button-->
<div id='buttoncontainer'>
    <a href='#' id="button">ADD YOUR POINT</a>
</div>
<div id='markerinfo'>
    <!-- Open and close sidebar -->
    <div id='sidebarbuttoncontainer'>
        <a href='#' id='sidebarbutton' title='Close sidebar'>X</a>
    </div>
    <div id="markerinfo2"></div>
    <div id="disqus_thread"></div>
</div>

<div id='formcontainer'>
    <form action="user_form_Pitt2.php" method="post" enctype="multipart/form-data">
        <div id='buttonCloser'>
            <a href='#' id="buttonCloser">X</a>
        </div>

        <div>
            <label style="font-style: italic">Click on the map to select location:</label>
        </div>

        <div>
            <label title="Create a user name.">Your Name:</label><br>
            <input name="cusp_name" required="required" type="text" id="cusp_name">
        </div>

        <div class="lat_long">
            <label>Latitude:</label>
            <input name="lat" required="required" type="text" id="lat">
        </div>


        <div class="lat_long">
            <label>Longitude:</label>
            <input name="lng" required="required" type="text" id="lng">
        </div>

        <div>
            <label title="Create a title for your data point.">Title:</label><br>
            <input name="cusp_title" required="required" type="text" id="cusp_title">
        </div>

        <div>
            <label>Select Type: </label><br><select name="marker_type" id="marker_type">
            <option value="event">Programs or Events</option>
            <option value="impact">Impacts and Observations</option>
            <option value="done">What's being done?</option>
        </select>
        </div>

        <div>
            <label style='color: #9c9c9c'>Optional</label><br><label style='color: #9c9c9c'title="Are you adding a Green Infrastructure project to the map?  Great!  Select the type of project and add as much info as you can to the description.  We'll verify it and add it to our database.  Thanks!">Select Green Infrastructure:</label> <select name="gi_type" id="gi_type">
            <option value="none"></option>
            <option value="bioswale">Bioswale</option>
            <option value="greenRoof">Green Roof</option>
            <option value="pervious">Pervious Pavement</option>
            <option value="rainwater">Rainwater Reuse System</option>
            <option value="treePit">Tree Planting</option>
            <option value="other">Other Green Infrastructure</option>
        </select>
        </div>

        <div>
            <label title="This is the body of your data point. Be sure to include all important details.">Description</label><br><textarea id="description" name="description"></textarea>
        </div>

        <div>
            <label for="file">Photo:</label><br>
            <input type="file" name="file" id="file">
            <!-- <p>Note, you will not be able to delete this photo.</p> -->
        </div>

        <div>
            <input value="Submit" type="submit">
            <p>Make sure to check your post for errors before you submit.</p>
        </div>
    </form>
</div>

<script type='text/javascript'>

L.mapbox.accessToken = 'pk.eyJ1IjoiY2xpbWF0ZSIsImEiOiJxT0gyWG9JIn0.8lxiVqz1OgK1WTZohHNwQQ';

// In case this is used in an older browser
if (!document.getElementsByClassName) {
    document.getElementsByClassName=function(cn) {
        var allT=document.getElementsByTagName('*'), allCN=[], i=0, a;
        while(a=allT[i++]) {
            a.className==cn ? allCN[allCN.length]=a : null;
        }
        return allCN
    }
}

//Array to hold the map layers
var mapLayers = new Array();

/** Sidebar control **/
var sidebarbutton = document.getElementById('sidebarbutton');
var body = document.getElementById('cuspbody');
sidebarbutton.onclick = function() {
    body.className = 'nosidebar';
    wastewater_button.className = '';
}
/** End of sidebar control **/

// Define click and mousemove for mouse position clicker
var click = document.getElementById('click');
var formButton = document.getElementById('button');
var formContainer = document.getElementById('formcontainer');
var latField = document.getElementById('lat');
var lngField = document.getElementById('lng');
var closeFormButton = document.getElementById('buttonCloser')

formButton.onclick = function() {
     formcontainer.className = 'active';
     body.className = 'nosidebar';
     // To hide the form, create some javascript to remove the "active" classname.
     map.on('click', function(e){
        latField.value = e.latlng.lat;
        lngField.value = e.latlng.lng;
        var latPt = latField.value;
        var lngPt = lngField.value;
        var tempPt = L.popup()
            .setLatLng([latPt, lngPt])
            .setContent("Your point will be here.")
            .openOn(map);
     });
};

closeFormButton.onclick = function() {
     formcontainer.className = '';
     map.off('click');
};

//Parameters for each slide in a story
var slideParam = function(marker, lati, longi, zoomStory, slideLayers, slideNumber) {
    this.marker = marker;
    this.zoomStory = zoomStory;
    this.slideLayers = slideLayers;
    this.lati = lati;
    this.longi = longi;
    this.slideNumber = slideNumber;
}

//Cycle through markers about Water and Climate
wastewater_button.onclick = function() {
    wastewater_button.className = 'active';
    var cuspMarkerLayer = L.mapbox.featureLayer()
        .loadURL('cusp_geojson_Pitt.php')
        //.addTo(map);
    cuspMarkerLayer.on('ready', function(e) {
        var markers2 = [];
        this.eachLayer(function(marker) {
            markers2.push(marker);
        });

    var slideContent = ['<iframe src="1_WhatIsWastewater.html" id="iframe" frameborder="0"></iframe>',  '<iframe src="2_ComplexSystem.html" id="iframe" frameborder="0"></iframe>','<iframe src="3_StormwaterRunoffImpacts.html" id="iframe" frameborder="0"></iframe>','<iframe src="4_CombinedSunny_s.html" id="iframe" frameborder="0"></iframe>', '<iframe src="5_CombinedRainy_s.html" id="iframe" frameborder="0"></iframe>', '<iframe src="6_ClimateChangeStress_s.html" id="iframe" frameborder="0"></iframe>', '<iframe src="7_WhatsBeingDone.html" id="iframe" frameborder="0"></iframe>', '<iframe src="8_SlowingStormwater.html" id="iframe" frameborder="0"></iframe>', '<iframe src="9_CommunityAction.html" id="iframe" frameborder="0"></iframe>', '<iframe src="10_GetInvolved_GI.html" id="iframe" frameborder="0"></iframe>'];

    var slide1 = new slideParam(slideContent[0], 40.434243, -80.090020, 12, ['alcosanPlantLayerName', 'csoPipeLayerName'], 1); //What is Wastewater?'
    var slide2 = new slideParam(slideContent[1], 40.476496844295, -80.24, 10,['alcosanLayerName', 'alcosanPlantLayerName', 'muniLayerName'], 2); //A complex system
    var slide3 = new slideParam(slideContent[2], 40.45, -80.05, 12, ['csoLayerName','csoPipeLayerName', 'floodHundredLayerName', 'floodFiveHundredLayerName'], 3); //Separate Sewer Impacts
    var slide4 = new slideParam(slideContent[3], 40.478977781523, -80.05, 16, ['satelliteLayerName', 'csoPipeLayerName'], 4); // Combined Sewer System Works
    var slide5 = new slideParam(slideContent[4], 40.45, -80.05, 12, ['csoLayerName', 'csoPipeLayerName'], 5);// Combined Sewer System Fails
    var slide6 = new slideParam(slideContent[5], 40.478977781523, -80.05, 7, ['weatherLayerName', 'precip2020s50LayerName'], 6); //Climate Change Stresses our System
    //var slide7 = new slideParam(slideContent[6], 40.45, -80.05, 12, ['imperviousLayerName']); //More hard surfaces as the city grows
    var slide8 = new slideParam(slideContent[6], 40.434243, -80.090020, 11, ['csoLayerName', 'csoPipeLayerName', 'selectedPlanLayerName'], 7); //What's being done?
    var slide9 = new slideParam(slideContent[7], 40.434243, -80.090020, 11, ['imperviousLayerName', 'bioswaleLayerName', 'greenRoofLayerName', 'permeablePavementLayerName', 'rainBarrelsLayerName', 'treePlantingsLayerName', 'successionalMeadowsLayerName'], 8); //Slowing Stormwater Down
    var slide10 = new slideParam(slideContent[9], 40.45, -80.05, 12, ['bioswaleLayerName', 'greenRoofLayerName', 'permeablePavementLayerName', 'rainBarrelsLayerName', 'treePlantingsLayerName', 'successionalMeadowsLayerName'], 9); //Green Infrastructure Projects
    var slide11 = new slideParam(slideContent[8], 40.45, -80.05, 12, ['communityLayerName', 'govtLayerName'], 99); //Community Action


    var wastewaterMarkers = [slide1, slide2, slide3, slide4, slide5, slide6, slide8, slide9, slide10, slide11];

    startStory(wastewaterMarkers, 0, 10);
    });
}

//Cycle through markers about Water and Climate
transportation_button.onclick = function() {
    transportation_button.className = 'active';
    var cuspMarkerLayer = L.mapbox.featureLayer()
        .loadURL('cusp_geojson_Pitt.php')
        //.addTo(map);
    cuspMarkerLayer.on('ready', function(e) {
        var markers2 = [];
        this.eachLayer(function(marker) {
            markers2.push(marker);
        });

    var transportationContent = ['<iframe src="TransportationStory/1_TransportationEmissions.html" id="iframe" frameborder="0"></iframe>',  '<iframe src="TransportationStory/2_CarbonFootprint.html" id="iframe" frameborder="0"></iframe>','<iframe src="TransportationStory/3_TransportationType.html" id="iframe" frameborder="0"></iframe>', '<iframe src="TransportationStory/4_OtherTransit.html" id="iframe" frameborder="0"></iframe>', '<iframe src="TransportationStory/5_ConsiderSuggest.html" id="iframe" frameborder="0"></iframe>', '<iframe src="TransportationStory/6_GetInvolved.html" id="iframe" frameborder="0"></iframe>'];

    var slide1 = new slideParam(transportationContent[0], 40.434243, -80.090020, 12, ['boundaryLayerName'], 1); //Pittsburgh Emissions Sources'
    var slide2 = new slideParam(transportationContent[1], 40.440188, -80.030454, 13,['co2LayerName'], 2); //CarbonFootprint
    var slide3 = new slideParam(transportationContent[2], 40.440188, -80.030454, 13, ['bikeLayerName', 'busLayerName','lightRailLayerName'], 3); //Transportation Types
    var slide4 = new slideParam(transportationContent[3], 40.434243, -80.090020, 12, ['bikeLayerName', 'busLayerName','lightRailLayerName', 'parkRideLayerName'], 4); // Consider and Suggest
    var slide5 = new slideParam(transportationContent[4], 40.440188, -80.030454, 13, ['bikeLayerName', 'busLayerName','lightRailLayerName','parkRideLayerName', 'vanpoolLayerName'], 5); // OtherTransit Options
    var slide6 = new slideParam(transportationContent[5], 40.434243, -80.090020, 12, ['communityLayerName', 'govtLayerName'], 99); // Get Involved
    // var slide5 = new slideParam(slideContent[4], 40.45, -80.05, 12, ['csoLayerName', 'csoPipeLayerName'], 5);// Combined Sewer System Fails
    // var slide6 = new slideParam(slideContent[5], 40.478977781523, -80.05, 7, ['weatherLayerName', 'precip2020s50LayerName'], 6); //Climate Change Stresses our System
    // //var slide7 = new slideParam(slideContent[6], 40.45, -80.05, 12, ['imperviousLayerName']); //More hard surfaces as the city grows
    // var slide8 = new slideParam(slideContent[6], 40.434243, -80.090020, 11, ['csoLayerName', 'csoPipeLayerName', 'selectedPlanLayerName'], 7); //What's being done?
    // var slide9 = new slideParam(slideContent[7], 40.434243, -80.090020, 11, ['imperviousLayerName', 'bioswaleLayerName', 'greenRoofLayerName', 'permeablePavementLayerName', 'rainBarrelsLayerName', 'treePlantingsLayerName', 'successionalMeadowsLayerName'], 8); //Slowing Stormwater Down
    // var slide10 = new slideParam(slideContent[9], 40.45, -80.05, 12, ['bioswaleLayerName', 'greenRoofLayerName', 'permeablePavementLayerName', 'rainBarrelsLayerName', 'treePlantingsLayerName', 'successionalMeadowsLayerName'], 9); //Green Infrastructure Projects
    // var slide11 = new slideParam(slideContent[8], 40.45, -80.05, 12, ['communityLayerName', 'govtLayerName'], 10); //Community Action


    var transportationMarkers = [slide1, slide2, slide3, slide4, slide5, slide6];

    startStory(transportationMarkers, 0, 5);
    });
}

// This keeps track of our progress through the story.
var storyProgress = new Object();

var startStory = function(storyMarkers, start, finish) {
    current = storyMarkers[start];
    storyProgress.markers = storyMarkers;
    storyProgress.progress = start;
    storyProgress.beginning = start;
    storyProgress.end = finish;
    center(current);
    storyLayers(current);

}

var center = function(current){
    map.setView([current.lati, current.longi], current.zoomStory);
    storyLayers(current);
    storyDisplay(current);
    getActiveCheckboxes();
    for (var i = 0; i < inactiveCheckboxes.length; i++) {
        closeSubtitle(inactiveCheckboxes[i].layerType);
    }

    for (var i = 0; i < activeCheckboxes.length; i++) {
        openSubtitle(activeCheckboxes[i].layerType);
    }
}


var storyLayers = function(current) {
    sameStateAll(false, inputs, checkboxes); // turn off all layers checkboxes

    for (var i = 0; i < checkboxes.length; i++) {
        if (checkboxes[i].layerId == current.slideLayers[0] || checkboxes[i].layerId == current.slideLayers[1] || checkboxes[i].layerId == current.slideLayers[2] || checkboxes[i].layerId == current.slideLayers[3] ||checkboxes[i].layerId == current.slideLayers[4] || checkboxes[i].layerId == current.slideLayers[5] || checkboxes[i].layerId == current.slideLayers[6] || checkboxes[i].layerId == current.slideLayers[7]) {
            checkboxes[i].checked = true;
            checkboxes[i].className = 'active';
            activateOnClick(checkboxes[i], 'change');
        }
    }
}

var storyDisplay = function(current){
    console.log(current);
    console.log(current.lati)
    if (current.slideNumber == 1) {
        var info = '</div>' + current.marker + '<div class="cycle">' +
            '<a href="#" class="next1" onclick="next()">NEXT >></a>';
    }
    else if (current.slideNumber == 99) {
        var info = '</div>' + current.marker + '<div class="cycle">' +
            '<a href="#" class="prev" onclick="prev()"><< PREVIOUS</a>';
    }
    else {
        var info = '</div>' + current.marker + '<div class="cycle">' +
            '<a href="#" class="prev" onclick="prev()"><< PREVIOUS</a>' +
            '<a href="#" class="next" onclick="next()">NEXT >></a>';
    }

    document.getElementById('markerinfo2').innerHTML = info;
        // Hide the marker adder if it's visible
    formcontainer.className = '';
        // Re-open the sidebar if it's hidden
    body.className = '';
}
// Next - get the progress from storyProgress, update the currrent value, and update the display.
function next() {
    if (storyProgress.progress < storyProgress.end) {
        storyProgress.progress = storyProgress.progress + 1;
        center(storyProgress.markers[storyProgress.progress]);
    }
    else if (storyProgress.progress = storyProgress.end) {
        storyProgress.progress = storyProgress.progress;
        //center(storyProgress.markers[storyProgress.progress]);
    }
    else {
        storyProgress.progress = storyProgress.beginning;
        center(storyProgress.markers[storyProgress.progress]);
    }
}

function prev() {
   if (storyProgress.progress > storyProgress.beginning) {
        storyProgress.progress = storyProgress.progress - 1;
        center(storyProgress.markers[storyProgress.progress]);
    }
    else if (storyProgress.progress = storyProgress.beginning) {
        storyProgress.progress = storyProgress.progress;
        //center(storyProgress.markers[storyProgress.progress]);
    }
    else {
        storyProgress.progress = storyProgress.end;
        center(storyProgress.markers[storyProgress.progress]);
    }
}

var map = L.mapbox.map('map','climate.map-twcsrrzs')
    .setView([40.435875,-79.9985], 11);

var ui = document.getElementById('map-ui');

//Define variables for legend

var satelliteLegend = new Array();
satelliteLegend[0] = {'title': 'Satellite'};

satelliteLayerName = {name:'Satellite', id: 'satelliteLayerName', address: 'climate.map-ygz3bnb6', layerType: 'baseMap'};

var terrainLegend = new Array();
terrainLegend[0] = {'title': 'Terrain'};

terrainLayerName = {name:'Terrain', id: 'terrainLayerName', address: 'climate.i22j0j4n', layerType: 'baseMap'};

var alcosanPlantLegend = new Array();
alcosanPlantLegend[0] = {'title': 'Wastewater Treatment Plant', 'class': 'alcosan'};

alcosanPlantLayerName = {name: 'ALCOSAN', id: 'alcosanPlantLayerName', address: 'climate.ALCOSAN', layerType: 'wastewater', title: 'The Allegheny County Sanitary Authority (ALCOSAN) provides wastewater treatment services to 83 communities including the City of Pittsburgh at their 59-acre treatment plant.'};

var alcosanLegend = new Array();
alcosanLegend[0] = {'title': 'Combined Sewer Area', 'class': 'combined'};
alcosanLegend[1] = {'title': 'Separate Sewer Area', 'class': 'separate'};
alcosanLegend[2] = {'title': 'Runoff towards combined area', 'class': 'runoff'};
alcosanLegend[3] = {'title': 'Non-contributing Area', 'class': 'non'};

alcosanLayerName = {name: 'ALCOSAN Service Area', id: 'alcosanLayerName', address: 'climate.Pittsburgh_AlcosanService', layerType: 'wastewater'};

var boundaryLegend = new Array();
boundaryLegend[0] = {'title': 'Pittsburgh City Boundary', 'class': 'boundary'};

boundaryLayerName = {name: 'City Boundaries', id: 'boundaryLayerName', address: 'climate.PittsburghCityBoundary', layerType: 'boundaries'};

var bikeLegend = new Array();
bikeLegend[0] = {'title': 'Trails', 'class': 'trails'};
bikeLegend[1] = {'title': 'Bike Lanes', 'class': 'bikeLane'};
bikeLegend[2] = {'title': 'Shared Lane Marking', 'class': 'sharrow'};

bikeLayerName = {name:'Bike Lanes', id: 'bikeLayerName', address: 'climate.PittsburghBikeLanes', layerType: 'transportation'};

var communityLegend = new Array();
communityLegend[0] = {'title': 'Wastewater', 'class': 'wastewater_comm'};
communityLegend[1] = {'title': 'Transportation', 'class': 'trans_comm'};

communityLayerName = {name: 'Community Groups', id: 'communityLayerName', layerType: 'groups'};

var communityGridLayer = L.mapbox.gridLayer('climate.Pittsburgh_CommunityGroups');
communityGridLayer.on('click', function(e) {
    console.log(e);
    if (!e.data) return;
    var content = '<h3>' + e.data.Agency + '</h3>' + '<br \/>' + e.data.Descr + '<br \/>' + e.data.Histor + '<br \/>' + '<a target="_blank" href="' + e.data.website + '">' + e.data.website + '</a>';
    var popup = L.popup()
        .setLatLng(e.latLng)
        .setContent(content)
        .openOn(map);
});

var govtLegend = new Array();
govtLegend[0] = {'title': 'Wastewater', 'class': 'wastewater_govt'};
govtLegend[1] = {'title': 'Transportation', 'class': 'trans_govt'};

govtLayerName = {name: 'Government Agencies', id: 'govtLayerName', layerType: 'groups'};

var govtGridLayer = L.mapbox.gridLayer('climate.Pittsburgh_GovtAgencies');
govtGridLayer.on('click', function(e) {
    console.log(e);
    if (!e.data) return;
    var content = '<h3>' + e.data.Agency + '</h3>' + '<br \/>' + e.data.Descr + '<br \/>' + e.data.Stance + '<br \/>' + '<br \/>' + '<a target="_blank" href="' + e.data.website + '">' + e.data.website + '</a>';
    var popup = L.popup()
        .setLatLng(e.latLng)
        .setContent(content)
        .openOn(map);
});

var greenRoofLegend = new Array();
greenRoofLegend[0] = {'title': 'Green Roofs', 'class': 'greenroof'};

greenRoofLayerName = {name: 'Green Roofs', id: 'greenRoofLayerName', layerType: 'adaptation', title: 'Green roofs are layers of soil and vegetation installed on rooftops that capture runoff. The vegetation allows evaporation and evapotranspiration to reduce the volume and discharge rate of stormwater. (NY DEC)'};

var greenRoofGridLayer = L.mapbox.gridLayer('climate.Pittsburgh_GreenRoofs');
greenRoofGridLayer.on('click', function(e) {
    console.log(e);
    if (!e.data) return;
    var content = '<h3>' + e.data.Type + '</h3>' + '<h4>' + e.data.project_na + '</h4>' + e.data.Descr + '<br \/>' + '<a target="_blank" href="' + e.data.website + '">' + e.data.website + '</a>' + '<br \/>' + '<img src="' + e.data.picture + '" />';
    console.log(content);
    var popup = L.popup()
        .setLatLng(e.latLng)
        .setContent(content)
        .openOn(map);
});

var rainBarrelsLegend = new Array();
rainBarrelsLegend[0] = {'title': 'Rain Barrels', 'class': 'rainwater'};

rainBarrelsLayerName = {name: 'Rainwater Retention', id: 'rainBarrelsLayerName', layerType: 'adaptation', title: 'Rain Barrels collect and store rainwater from roof tops for later use. They reduce the amount of quickly moving water that can overwhelm storm sewers and streams during a storm.'};

var rainBarrelsGridLayer = L.mapbox.gridLayer('climate.Pittsburgh_RainBarrels');
rainBarrelsGridLayer.on('click', function(e) {
    console.log(e);
    if (!e.data) return;
    var content = '<h3>' + e.data.Type + '</h3>' + '<h4>' + e.data.project_na + '</h4>' + e.data.Descr + '<br \/>' + '<a target="_blank" href="' + e.data.website + '">' + e.data.website + '</a>' + '<br \/>' + '<img src="' + e.data.picture + '" />';
    console.log(content);
    var popup = L.popup()
        .setLatLng(e.latLng)
        .setContent(content)
        .openOn(map);
});

var permeablePavementLegend = new Array();
permeablePavementLegend[0] = {'title': 'Permeable Paving', 'class': 'pervious'};

permeablePavementLayerName = {name: 'Permeable Surfaces', id: 'permeablePavementLayerName', layerType: 'adaptation', title: 'Pervious and Permeable Pavements are porous surfaces that absorb stormwater into the ground below. As a result, stormwater doesn\'t stream as quickly into gutters where it can overwhelm storm sewers.'};

var permeablePavementGridLayer = L.mapbox.gridLayer('climate.Pittsburgh_PermeablePavement');
permeablePavementGridLayer.on('click', function(e) {
    console.log(e);
    if (!e.data) return;
    var content = '<h3>' + e.data.Type + '</h3>' + '<h4>' + e.data.project_na + '</h4>' + e.data.Descr + '<br \/>' + '<a target="_blank" href="' + e.data.website + '">' + e.data.website + '</a>' + '<br \/>' + '<img src="' + e.data.picture + '" />';
    console.log(content);
    var popup = L.popup()
        .setLatLng(e.latLng)
        .setContent(content)
        .openOn(map);
});

var rainGardenLegend = new Array();
rainGardenLegend[0] = {'title': 'Rain Gardens', 'class': 'garden'};

rainGardenLayerName = {name: 'Rain Gardens', id: 'rainGardenLayerName', layerType: 'adaptation', title: 'Rain Gardens are designed to collect runoff from impervious (hard) surfaces such as roofs, roads and parking lots. Once collected in the garden, water is slowly absorbed into the ground rather than flowing into the sewer system. (Philadelphia Water Department)'};

var rainGardenGridLayer = L.mapbox.gridLayer('climate.Pittsburgh_RainGardens');
rainGardenGridLayer.on('click', function(e) {
    console.log(e);
    if (!e.data) return;
    var content = '<h3>' + e.data.Type + '</h3>' + '<h4>' + e.data.project_na + '</h4>' + e.data.Descr + '<br \/>' + '<a target="_blank" href="' + e.data.website + '">' + e.data.website + '</a>' + '<br \/>' + '<img src="' + e.data.picture + '" />';
    console.log(content);
    var popup = L.popup()
        .setLatLng(e.latLng)
        .setContent(content)
        .openOn(map);
});

var successionalMeadowsLegend = new Array();
successionalMeadowsLegend[0] = {'title': 'Successional Meadows', 'class': 'meadow'};

successionalMeadowsLayerName = {name: 'Habitat Restoration', id: 'successionalMeadowsLayerName', layerType: 'adaptation', title: 'Successional Meadows are intentionally planted fields that increase natural habitat for animal and diverse plant life while also increasing stormwater absorption. Once planted they require little or no maintenance and will eventually become a mature forest.'};

var successionalMeadowsGridLayer = L.mapbox.gridLayer('climate.Pittsburgh_SuccessionalMeadows');
successionalMeadowsGridLayer.on('click', function(e) {
    console.log(e);
    if (!e.data) return;
    var content = '<h3>' + e.data.Type + '</h3>' + '<h4>' + e.data.project_na + '</h4>' + e.data.Descr + '<br \/>' + '<a target="_blank" href="' + e.data.website + '">' + e.data.website + '</a>' + '<br \/>' + '<img src="' + e.data.picture + '" />';
    console.log(content);
    var popup = L.popup()
        .setLatLng(e.latLng)
        .setContent(content)
        .openOn(map);
});

var treePlantingsLegend = new Array();
treePlantingsLegend[0] = {'title': 'Tree Plantings', 'class': 'treePlanting'};

treePlantingsLayerName = {name: 'Tree Plantings', id: 'treePlantingsLayerName', layerType: 'adaptation', title: 'Trees and forests play an incredible role in reducing stormwater and removing or filtering pollutants that would otherwise wind up in our waterways.'};

var treePlantingsGridLayer = L.mapbox.gridLayer('climate.Pittsburgh_TreePlantings');
treePlantingsGridLayer.on('click', function(e) {
    console.log(e);
    if (!e.data) return;
    var content = '<h3>' + e.data.Type + '</h3>' + '<h4>' + e.data.project_na + '</h4>' + e.data.Descr + '<br \/>' + '<a target="_blank" href="' + e.data.website + '">' + e.data.website + '</a>' + '<br \/>' + '<img src="' + e.data.picture + '" />';
    console.log(content);
    var popup = L.popup()
        .setLatLng(e.latLng)
        .setContent(content)
        .openOn(map);
});

var bioswaleLegend = new Array();
bioswaleLegend[0] = {'title': 'Bioswales/Rain Gardens', 'class': 'bioswale'};

bioswaleLayerName = {name: 'Bioswales', id: 'bioswaleLayerName', layerType: 'adaptation', title: 'A bioswale is a water management strategy consisting of a sloped area designed to capture and convey water, while allowing it to seep into the ground slowly over the course of a day or two. The slopes are usually planted with native species and bioswales look like rain gardens. See if you can find some images of bioswales on the map, and then try to spot one next time you\'re out in your neighborhood.'};

var bioswaleGridLayer = L.mapbox.gridLayer('climate.Pittsburgh_Bioswales');
bioswaleGridLayer.on('click', function(e) {
    console.log(e);
    if (!e.data) return;
    var content = '<h3>' + e.data.Type + '</h3>' + '<h4>' + e.data.project_na + '</h4>' + e.data.Descr + '<br \/>' + '<a target="_blank" href="' + e.data.website + '">' + e.data.website + '</a>' + '<br \/>' + '<img src="' + e.data.picture + '" />';
    console.log(content);
    var popup = L.popup()
        .setLatLng(e.latLng)
        .setContent(content)
        .openOn(map);
});

var co2Legend = new Array();
co2Legend[0] = {'title': 'Hybrid Carpool (3 Occupants)', 'class': 'hybrid3'};
co2Legend[1] = {'title': 'Transit Bus (75% Full)', 'class': 'bus75'};
co2Legend[2] = {'title': 'Carpool (3 Occupants)', 'class': 'car3'};
co2Legend[3] = {'title': 'SUVpool (3 Occupants)', 'class': 'suv3'};
co2Legend[4] = {'title': 'Hybrid Car (Solo Driver)', 'class': 'hybrid1'};
co2Legend[5] = {'title': 'Light Rail (75% Full)', 'class': 'lr75'};
co2Legend[6] = {'title': 'Transit Bus (Avg, 21% Full)', 'class': 'bus21'};
co2Legend[7] = {'title': 'Car (Solo Driver)', 'class': 'car1'};
co2Legend[8] = {'title': 'SUV (Solo Driver)', 'class': 'suv1'};
co2Legend[9] = {'title': 'Light Rail (Avg, 30% Full)', 'class': 'lr30'};
co2Legend[10] = {'title': 'Duquesne Incline', 'class': 'duq'};
co2Legend[11] = {'title': 'Monongahela Incline ', 'class': 'mon'};

co2LayerName = {name: 'CO2 Emissions', id: 'co2LayerName', layerType: 'transportation'};

var co2GridLayer = L.mapbox.gridLayer('climate.Pittsburgh_CO2Distance2');
co2GridLayer.on('click', function(e) {
    console.log(e);
    if (!e.data) return;
    var content = '<h3>' + e.data.Mode + '</h3>' + e.data.Dist + " to emit 1 lb of CO2";
    console.log(content);
    var popup = L.popup()
        .setLatLng(e.latLng)
        .setContent(content)
        .openOn(map);
});

var csoLegend = new Array();
csoLegend[0] = {'title':'Combined Sewer Outfall',  'class': 'cso'};
csoLegend[1] = {'title':'Sanitary Sewer Outfall',  'class': 'sso'};

csoLayerName = {name: 'Sewer Outfalls', id: 'csoLayerName', title: 'A combined sewer is a sewer system that carries both sanitary sewage and runoff from streets.  After heavy rain, the system can become overwhelmed, and a mix of excess stormwater and untreated wastewater enter into waterways out of the combined sewer overflow outfalls.', address: 'climate.Pittsburgh_CSOs', layerType: 'wastewater'};

var csoPipesLegend = new Array();
csoPipesLegend[0] = {'title': 'Deep Tunnel Interceptors', 'class': 'deepPipe'};
csoPipesLegend[1] = {'title': 'Shallow Cut Interceptors', 'class': 'shallowPipe'};

csoPipeLayerName = {name: 'Sewer Pipes', id: 'csoPipeLayerName', title: 'These large underground pipes are located along rivers or streams and carry sewage and storm water to the Allegheny County Sanitary Authority (ALCOSAN) for treatment.', address: 'climate.Pittsburgh_InterceptorPipes', layerType: 'wastewater'};

var selectedPlanLegend = new Array();
selectedPlanLegend[0] = {'title': 'Storage Tank (CSO)', 'class': 'csoTank'};
selectedPlanLegend[1] = {'title': 'Storage Tank (SSO)', 'class': 'ssoTank'};
selectedPlanLegend[2] = {'title': 'Drop Shaft', 'class': 'dropShaft'};
selectedPlanLegend[3] = {'title': 'Tunnel (CSO)', 'class': 'csoTunnel'};
selectedPlanLegend[4] = {'title': 'Tunnel (SSO)', 'class': 'ssoTunnel'};
selectedPlanLegend[5] = {'title': 'Conveyance', 'class': 'conveyance'};

selectedPlanLayerName = {name: 'ALCOSAN\'s Selected Plan', id: 'selectedPlanLayerName', title: 'The 3.6 billion dollar Wastewater System Plan that ALCOSAN submitted to the Environmental Protection Agency (EPA) in January of 2013.', address: 'climate.ALCOSAN_SelectedPlan', layerType: 'wastewater'};


var floodHundredLegend = new Array();
floodHundredLegend[0] = {'title': 'FEMA 100 Year Flood Zone', 'class': 'floodOneHundred'};

floodHundredLayerName = {name: '100 Year Flood', id: 'floodHundredLayerName', address: 'climate.AlleghenyCoFIRM_100yr', layerType: 'hazards'};

var floodFiveHundredLegend = new Array();
floodFiveHundredLegend[0] = {'title': 'FEMA 500 Year Flood Zone', 'class': 'floodFiveHundred'};

floodFiveHundredLayerName = {name: '500 Year Flood', id: 'floodFiveHundredLayerName', address: 'climate.AlleghenyCoFIRM_500yr', layerType: 'hazards'};

// var greenwayLegend = new Array();
// greenwayLegend[0] = {'title': 'Greenways', 'class': 'greenway'};

// greenwayLayerName = {name: 'Greenways', id: 'greenwayLayerName', address: 'climate.PittsburghGreenway', layerType: 'transportation'};

var busLegend = new Array();
busLegend[0] = {'title': 'Local Routes', 'class': 'local'};
busLegend[1] = {'title': 'Key Corridors', 'class': 'corridor'};
busLegend[2] = {'title': 'Commuter Routes', 'class': 'commuter'};
busLegend[3] = {'title': 'Bus Rapid Transit', 'class': 'rapid'};
busLegend[4] = {'title': 'Busways', 'class': 'busway'};

lightRailLayerName = {name: 'Light Rail', id: 'lightRailLayerName', address: 'climate.Pittsburgh_LightRail', layerType: 'transportation'};

var lightRailLegend = new Array();
lightRailLegend[0] = {'title': 'Blue Line', 'class': 'blueLine'};
lightRailLegend[1] = {'title': 'Blue Line Library', 'class': 'blueLineLibrary'};
lightRailLegend[2] = {'title': 'Red Line', 'class': 'redLine'};

busLayerName = {name: 'Bus Routes', id: 'busLayerName', address: 'climate.Pittsburgh_BusRoutes', layerType: 'transportation'};

var parkRideLegend = new Array();
parkRideLegend[0] = {'title': 'Parking Lots', 'class': 'parkRide'};

parkRideLayerName = {name: 'Park and Ride Locations', id: 'parkRideLayerName', layerType: 'transportation'};

var parkRideGridLayer = L.mapbox.gridLayer('climate.Pittsburgh_ParkAndRide');
parkRideGridLayer.on('click', function(e) {
    console.log(e);
    if (!e.data) return;
    var content = '<h3>' + e.data.Name + '</h3>' + '<h4>' + "CAPACITY: " + e.data.Capacity + '</h4>' + "Buses: " + e.data.BusLInes + "Light Rail: " + e.data.RailLines;
    console.log(content);
    var popup = L.popup()
        .setLatLng(e.latLng)
        .setContent(content)
        .openOn(map);
});

var vanpoolLegend = new Array();
vanpoolLegend[0] = {'title': 'Origin City', 'class': 'vanpool'};

vanpoolLayerName = {name: 'Vanpools', id: 'vanpoolLayerName', title: 'A vanpool is a group of 7 to 15 people who commute together but do not necessarily work or attend school in the same location.  Vanpools typically travel more than 15 miles one way and only have one scheduled trip into work or school and back home per day. This option is good for people who work the same shift or attend school the same hours every day.', layerType: 'transportation'};

var vanpoolGridLayer = L.mapbox.gridLayer('climate.Pittsburgh_VanPool');
vanpoolGridLayer.on('click', function(e) {
    console.log(e);
    if (!e.data) return;
    var content = '<h3>' + "Vanpool" + '</h3>' + "Origin City: " + e.data.Origin + '<br>' + "Destination City: " + e.data.Destinatio;
    console.log(content);
    var popup = L.popup()
        .setLatLng(e.latLng)
        .setContent(content)
        .openOn(map);
});

var imperviousLegend = new Array();
imperviousLegend[0] = {'title': 'Buildings', 'class': 'buildings'};
imperviousLegend[1] = {'title': 'Roads', 'class': 'roads'};
imperviousLegend[2] = {'title': 'Other Impervious Surfaces', 'class': 'impervious'};


imperviousLayerName = {name:'Impervious Surfaces', id: 'imperviousLayerName', title: 'Impervious surfaces are hard surfaces, such as sidewalks and streets, that don\'t allow water to seep into the ground. Water that does not soak into the ground becomes runoff and travels to the nearest body of water.', address: 'climate.AlleghenyImpervious', layerType: 'hazards'};

var giLegend = new Array();
giLegend[0] = {'title':'Bioswale',  'class': 'bioswale'};
giLegend[1] = {'title':'Green Roof',  'class': 'greenroof'};
giLegend[2] = {'title':'Pervious Surfaces',  'class': 'pervious'};
giLegend[3] = {'title':'Rain Barrel',  'class': 'rainwater'};
giLegend[4] = {'title':'Successional Meadow',  'class': 'meadow'};
giLegend[5] = {'title':'Tree Planting',  'class': 'treePlanting'};

giLayerName = {name: 'Green Infrastructure', id: 'giLayerName', layerType: 'adaptation'};

// var giGridLayer = L.mapbox.gridLayer('gi_geojson_Pitt.php');
// giGridLayer.on('click', function(e) {
//     e.layer.unbindPopup();
//     var feature = e.layer.feature;

//     var content = '<h3>' + feature.properties.gi + '</h3>' + '<h4>' + feature.properties.cusp_title + '</h4>' + feature.properties.description + '<br \/>' + '<a target="_blank" href="' + feature.properties.website + '">' + feature.properties.website + '</a>' + '<br \/>' + '<img src="' + feature.properties.photo + '" />';
//     var popup = L.popup()
//         .setLatLng(e.latLng)
//         .setContent(content)
//         .openOn(map);
// });

var markerLegend = new Array();
markerLegend[0] = {'title':'Programs & Events', 'class': 'programs_events'};
markerLegend[1] = {'title':'Impacts & Observations', 'class': 'impacts_observations'};
markerLegend[2] = {'title':'What\'s being done?', 'class': 'whats_being_done'};

markerLayerName = {name: 'Crowd-Sourced Points', id: 'markerLayerName', layerType: 'markers'};

var muniLegend = new Array();
muniLegend[0] = {'title': 'Township Boundaries', 'class': 'muni'};

muniLayerName = {name: 'Municipality Boundaries', id: 'muniLayerName', address: 'climate.Pittsburgh_Municipal', layerType: 'boundaries'};

var neighborhoodLegend = new Array();
neighborhoodLegend[0] = {'title': 'Pittsburgh Neighborhoods', 'class': 'neighborhoods'};

neighborhoodLayerName = {name: 'Neighborhoods', id: 'neighborhoodLayerName', address: 'climate.Pittsburgh_Neighborhoods', layerType: 'boundaries'};

var powerPlantsLegend = new Array();
powerPlantsLegend[0] = {'title':'Green Power Plants', 'class': 'green_power'};
powerPlantsLegend[1] = {'title':'Fossil Fuel Power Plants', 'class': 'fossil_fuel_power'};
powerPlantsLegend[2] = {'title':'Other Power Plants', 'class': 'other_power'};

powerPlantsLayerName = {name: 'Power Plants', id: 'powerPlantsLayerName', address: 'climate.PowerPlants_Pitt', layerType: 'energy'};

var precip2020s50Legend = new Array();
precip2020s50Legend[0] = {'title':'+ 4.1% - 5%', 'class': 'fourtoFive'};
precip2020s50Legend[1] = {'title':'+ 5.1% - 6%', 'class': 'fivetoSix'};
precip2020s50Legend[2] = {'title':'+ 6.1% - 7%', 'class': 'sixtoSeven'};

precip2020s50LayerName = {name: 'Projected Precipitation Change - 2020\'s', id: 'precip2020s50LayerName', address: 'climate.PA_PrecipChange2020s50', layerType: 'projections'};

var precip2050s50Legend = new Array();
precip2050s50Legend[0] = {'title':'+ 7.1% - 8%', 'class': 'seventoEight'};
precip2050s50Legend[1] = {'title':'+ 8.1% - 9%', 'class': 'eighttoNine'};
precip2050s50Legend[2] = {'title':'+ 9.1% - 10%', 'class': 'ninetoTen'};
precip2050s50Legend[3] = {'title':'+ 10.1% - 11%', 'class': 'tentoEleven'};
precip2050s50Legend[4] = {'title':'+ 11.1% - 12%', 'class': 'eleventoTwelve'};


precip2050s50LayerName = {name: 'Projected Precipitation Change - 2050\'s', id: 'precip2050s50LayerName', address: 'climate.PA_PrecipChange2050s50', layerType: 'projections'};

var precip2080s50Legend = new Array();
precip2080s50Legend[0] = {'title':'+ 10.1% - 11%', 'class': 'tentoEleven'};
precip2080s50Legend[1] = {'title':'+ 11.1% - 12%', 'class': 'eleventoTwelve'};
precip2080s50Legend[2] = {'title':'+ 12.1% - 13%', 'class': 'twelvetoThirteen'};
precip2080s50Legend[3] = {'title':'+ 13.1% - 14%', 'class': 'thirteentoFourteen'};
precip2080s50Legend[4] = {'title':'+ 14.1% - 15%', 'class': 'fourteentoFifteen'};

precip2080s50LayerName = {name: 'Projected Precipitation Change - 2080\'s', id: 'precip2080s50LayerName', address: 'climate.PA_PrecipChange2080s50', layerType: 'projections'};

var sewershedLegend = new Array();
sewershedLegend[0] = {'title': 'Allegheny County Stormwater Watersheds', 'class':'sewershed'};

sewershedLayerName = {name: 'Stormwater Management Watersheds', id: 'sewershedLayerName', address: 'climate.Pittsburgh_Sewageshed', layerType: 'wastewater'};

var underminedLegend = new Array();
underminedLegend[0] = {'title': 'Undermined Areas', 'class':'undermined'};

underminedLayerName = {name: 'Mining', id: 'underminedLayerName', address: 'climate.UnderminedAreas', layerType: 'hazards'};

var landslideLegend = new Array();
landslideLegend[0] = {'title': 'Landslide Prone Areas', 'class': 'landslide'};

landslideLayerName = {name: 'Landslides', id: 'landslideLayerName', address: 'climate.LandslideProne', layerType: 'hazards'};

var watershedLegend = new Array();
watershedLegend[0] = {'title': 'Watersheds', 'class': 'watershed'};

watershedLayerName = {name: 'Watersheds', id: 'watershedLayerName', address: 'climate.PennsylvaniaWatersheds', layerType: 'natural'};

var weatherLegend = new Array();
weatherLegend[0] = {'title':'Weather Stations',  'class': 'weather'};

weatherLayerName = {name: 'Weather Stations', title: 'Weather stations with Baseline Temperature & Precipitation - Average from 1971 - 2000.', id: 'weatherLayerName', layerType: 'projections'};

var weatherGridLayer = L.mapbox.gridLayer('climate.Pittsburgh_WeatherStations');
weatherGridLayer.on('click', function(e) {
    console.log(e);
    if (!e.data) return;

    var content = '<div id="weatherContent">' + '<h3>' + e.data.Station + ' Weather Station' + '<\/h3>' + '<img src="' + e.data.TempPro + '"/>' + 'Projections are an average from a range of emission scenarios.  The actual level of climate change will likely be larger if greenhouse gas emissions continue on their recent trajectory, or smaller if we move towards a less carbon-intensive society.' + '</div>';
    //e.bindPopup(content).openPopup();
    var popup = L.popup({maxWidth:600})
        .setLatLng(e.latLng)
        .setContent(content)
        .openOn(map);
});

baseLayerSubtitle = {name: 'BASE LAYERS'};
politicalBoundariesSubtitle = {name: 'POLITICAL BOUNDARIES'};
naturalBoundariesSubtitle = {name: 'NATURAL BOUNDARIES'};
transportationSubtitle = {name:'TRANSPORTATION'};
wastewaterSubtitle = {name: 'WASTEWATER', title: 'Heavy rains can affect how the city\'s sewer systems are able to process wastewater. With climate change predicted, to increase the frequency and severity of precipitation events, the city is finding new ways to handle our wastewater.'};
waterSupplySubtitle = {name: 'WATER SUPPLY'};
energySubtitle = {name:' ENERGY', title: 'With climate change predicted to increase the average number of days with temperatures over 90 degrees F, our energy system will have extra work to do cooling our city\'s buildings and other systems.  Explore this layer to see where our energy comes from.'};
hazardsSubtitle = {name:'NATURAL HAZARDS'};
projectionsSubtitle = {name: 'CLIMATE PROJECTIONS'};
markerSubtitle = {name:'CROWD-SOURCED DATA', title: 'You can explore data points that are already up on the map, or add your own climate change observation or question using the Add Your Point button in the upper right corner of the map. Programs or Events will show you events related to climate change, Impacts and Observations are local stories about how climate change is impacting Pittsburgh, and What\'s Being Done? provides information about how the city and its people are responding to climate change.'};
groupsSubtitle = {name: 'WHO\'S INVOLVED'};
adaptationSubtitle = {name: 'GREEN INFRASTRUCTURE', title: 'Explore these layers to see how our community is preparing for storm and heat related impacts of climate change.'};

addSubTitle('baseMap', baseLayerSubtitle);
addLayer('climate.map-ygz3bnb6', satelliteLayerName,'', satelliteLegend, null, 'baseMap');
// addLayer('climate.i22j0j4n', terrainLayerName,'', terrainLegend, null, 'baseMap');
addSubTitle('boundaries', politicalBoundariesSubtitle);
addLayer('climate.AlleghenyMunicipal', muniLayerName, '', muniLegend, null, 'boundaries');
addLayer('climate.PittsburghCityBoundary', boundaryLayerName, '', boundaryLegend, null, 'boundaries');
addLayer('climate.Pittsburgh_Neighborhoods', neighborhoodLayerName, '', neighborhoodLegend, null, 'boundaries');
addSubTitle('transportation', transportationSubtitle);
addLayer('climate.PittsburghBikeLanes', bikeLayerName, '', bikeLegend, null, 'transportation');
// addLayer('climate.PittsburghGreenway', greenwayLayerName, '', greenwayLegend, null, 'transportation');
addLayer('climate.Pittsburgh_BusRoutes', busLayerName, '', busLegend, null, 'transportation');
addLayer('climate.Pittsburgh_LightRail', lightRailLayerName, '', lightRailLegend, null, 'transportation');
addLayer('climate.Pittsburgh_ParkAndRide', parkRideLayerName, '', parkRideLegend, parkRideGridLayer, 'transportation');
addLayer('climate.Pittsburgh_VanPool', vanpoolLayerName, '', vanpoolLegend, vanpoolGridLayer, 'transportation');
addLayer('climate.Pittsburgh_CO2Distance2', co2LayerName, '', co2Legend, co2GridLayer, 'transportation');
addSubTitle('natural', waterSupplySubtitle);
addLayer('climate.PennsylvaniaWatersheds', watershedLayerName, '', watershedLegend, null, 'natural');
addSubTitle('wastewater', wastewaterSubtitle);
addLayer('climate.ALCOSAN', alcosanPlantLayerName, '', alcosanPlantLegend, null, 'wastewater');
addLayer('climate.Pittsburgh_InterceptorPipes', csoPipeLayerName, '', csoPipesLegend, null, 'wastewater');
addLayer('climate.Pittsburgh_CSOs', csoLayerName, '', csoLegend, null, 'wastewater');
// addLayer('climate.Pittsburgh_Sewageshed', sewershedLayerName, '', sewershedLegend, null, 'wastewater');
addLayer('climate.ALCOSAN_SelectedPlan', selectedPlanLayerName, '', selectedPlanLegend, null, 'wastewater');
addLayer('climate.ALCOSAN_ServiceArea', alcosanLayerName, '', alcosanLegend, null, 'wastewater');
addSubTitle('hazards', hazardsSubtitle);
addLayer('climate.AlleghenyCoFIRM_100yr', floodHundredLayerName, '', floodHundredLegend, null, 'hazards');
addLayer('climate.AlleghenyCoFIRM_500yr', floodFiveHundredLayerName, '', floodFiveHundredLegend, null, 'hazards');
addLayer('climate.AlleghenyImpervious', imperviousLayerName, '', imperviousLegend, null, 'hazards');
addLayer('climate.UnderminedAreas', underminedLayerName, '', underminedLegend, null, 'hazards');
addLayer('climate.LandslideProne', landslideLayerName, '', landslideLegend, null, 'hazards');
addSubTitle('energy', energySubtitle);
addLayer('climate.PowerPlants_Pitt', powerPlantsLayerName, '', powerPlantsLegend, null, 'energy');
addSubTitle('projections', projectionsSubtitle);
addLayer('climate.NE_AvgPrecipChange2020s', precip2020s50LayerName, '', precip2020s50Legend, null, 'projections');
addLayer('climate.NE_AvgPrecipChanges2050s', precip2050s50LayerName, '', precip2050s50Legend, null, 'projections');
addLayer('climate.NE_AvgPrecipChange2080s', precip2080s50LayerName, '', precip2080s50Legend, null, 'projections');
addLayer('climate.Pittsburgh_WeatherStations', weatherLayerName, '', weatherLegend, weatherGridLayer, 'projections');
addSubTitle('adaptation', adaptationSubtitle);
//addLayer('gi_geojson_Pitt.php', giLayerName, 'active', giLegend, null, 'adaptation');
addLayer('gi_geojson_Pitt.php', bioswaleLayerName, '', bioswaleLegend, bioswaleGridLayer, 'adaptation', 'bioswale');
addLayer('gi_geojson_Pitt.php', greenRoofLayerName, '', greenRoofLegend, greenRoofGridLayer, 'adaptation', 'greenRoof');
addLayer('gi_geojson_Pitt.php', permeablePavementLayerName, '', permeablePavementLegend, permeablePavementGridLayer, 'adaptation', 'pervious');
//addLayer('gi_geojson_Pitt.php', rainGardenLayerName, '', rainGardenLegend, rainGardenGridLayer, 'adaptation', 'rainGarden');
addLayer('gi_geojson_Pitt.php', rainBarrelsLayerName, '', rainBarrelsLegend, rainBarrelsGridLayer, 'adaptation', 'rainwater');
addLayer('gi_geojson_Pitt.php', successionalMeadowsLayerName, '', successionalMeadowsLegend, successionalMeadowsGridLayer, 'adaptation', 'meadow');
addLayer('gi_geojson_Pitt.php', treePlantingsLayerName, '', treePlantingsLegend, treePlantingsGridLayer, 'adaptation', 'treePit');
addSubTitle('groups', groupsSubtitle);
addLayer('climate.Pittsburgh_CommunityGroups', communityLayerName, '', communityLegend, communityGridLayer, 'groups');
addLayer('climate.Pittsburgh_GovtAgencies', govtLayerName, '', govtLegend, govtGridLayer, 'groups');
addSubTitle('markers', markerSubtitle);
addLayer('cusp_geojson_Pitt.php', markerLayerName, 'active', markerLegend, null, 'markers');

// Getting a list of all subtitle elements
var subtitleInputs = document.getElementsByClassName("subtitlecontainer");
var subtitleType = []; //will contain the type of all subtitle elements
function getSubtitleType() {
    for (var i = 0; i < subtitleInputs.length; i++) {
        if (subtitleInputs) {
            subtitleType.push(subtitleInputs[i].type);
        }
    }
}

// Getting list of all checkboxes
var inputs = document.getElementsByTagName("input");
var checkboxes = []; //will contain all checkboxes
for (var i = 0; i < inputs.length; i++) {
    if (inputs[i].type == "checkbox") {
    checkboxes.push(inputs[i]);
    }
}

// Getting a list of the layer type of all active checkboxes
var activeCheckboxes = []; // will contain all active layers
var inactiveCheckboxes = [] // will contain all layers that are not active
function getActiveCheckboxes() {
    activeCheckboxes.length = 0;
    inactiveCheckboxes.length = 0;
    for (var i = 0; i < checkboxes.length; i++) {
        if (checkboxes[i].checked == true) {
            activeCheckboxes.push(checkboxes[i]);
        }
        else{
            inactiveCheckboxes.push(checkboxes[i]);
        }
    }
}

getSubtitleType();
getActiveCheckboxes();
console.log(inactiveCheckboxes);
for (var i = 0; i < activeCheckboxes.length; i++) {
    openSubtitle(activeCheckboxes[i].layerType);
}
for (var i = 0; i < inactiveCheckboxes.length; i++) {
    closeSubtitle(inactiveCheckboxes[i].layerType);
}

function addSubTitle(layerType, subtitleName) {
    var item = document.createElement('li');
    item.className = 'subtitlecontainer';
    item.setAttribute("type", layerType);

    var titleHeader = document.createElement('h3');
    titleHeader.innerHTML = subtitleName.name;
    if (subtitleName.title) {
        titleHeader.title = subtitleName.title;
    }

    // The info that describes the SubTitle
    var subtitleinfobutton = document.createElement('button');
    subtitleinfobutton.innerHTML = "i";
    if (subtitleName.title) {
        subtitleinfobutton.content = subtitleName.title;
    }

    // Handle the click of the info button
    subtitleinfobutton.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        popUp(subtitleinfobutton.content);
    }

    //Nest layers under SubTitle
    var layerToggle = document.createElement('a');
    layerToggle.layerType = layerType;
    layerToggle.href = '#';
    layerToggle.className = 'layerToggle';
    layerToggle.innerHTML = '+';
    window.layerToggle = layerToggle;
    layerToggle.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        var layers = document.getElementsByClassName(layerType);
        for (var i = 0; i < layers.length; ++i) {
            var layer = layers[i];
            if(layer.style.display == 'list-item') {
                layer.style.display = 'none';
                layerToggle.innerHTML = '+';
                layerToggle.className = 'layerToggle plus';
            }

            else {
                layer.style.display = 'list-item';
                layerToggle.innerHTML = '&ndash;';
                layerToggle.className = 'layerToggle minus';
            }
        }
    }

    item.appendChild(layerToggle);
    item.appendChild(titleHeader);
    if (subtitleName.title) {
        item.appendChild(subtitleinfobutton);
    }
    ui.appendChild(item);
}

function closeSubtitle(typeOfLayer) {
    var layers = document.getElementsByClassName(typeOfLayer);
        for (var i = 0; i < layers.length; ++i) {
            var layer = layers[i];
            layer.style.display = 'none';
            layerToggle.innerHTML = '+';
            layerToggle.className = 'layerToggle plus';
        }
}

function openSubtitle(typeOfLayer) {
    var layers = document.getElementsByClassName(typeOfLayer);
        for (var i = 0; i < layers.length; ++i) {
            var layer = layers[i];
            layer.style.display = 'list-item';
            layerToggle.innerHTML = '&ndash;';
            layerToggle.className = 'layerToggle minus';
        }
}

function addLayer(layerId, layerName, activeStatus, layerLegend, interaction, layerType, giType) {
    if(layerName == markerLayerName) {
        var cuspMarkerLayer = L.mapbox.featureLayer();
        cuspMarkerLayer.addTo(map);
        var markerLayer = cuspMarkerLayer.loadURL('cusp_geojson_Pitt.php');
        var layer = [];
        layer = cuspMarkerLayer.setFilter(function(f) {
            if (f.properties['layer'] == 'marker') {
                return true;
            }
            else
                return false;
        });
    }

    else if (layerType == 'adaptation'){
        var cuspMarkerLayer = L.mapbox.featureLayer();
        var markerLayer = cuspMarkerLayer.loadURL(layerId);
        var layer = [];
        layer = cuspMarkerLayer.setFilter(function(f) {
            if (f.properties['layer'] == 'gi' && f.properties['gi_type'] == giType) {
                 return true;
            }
            else
                return false;
        });

        adaptationPopup(layer);
    // else if (layerType == 'adaptation'){
    //     var cuspMarkerLayer = L.mapbox.markerLayer();
    //     cuspMarkerLayer.addTo(map);
    //     var markerLayer = cuspMarkerLayer.loadURL('gi_geojson_Pitt.php');
    //     var layer = [];
    //     layer = cuspMarkerLayer.setFilter(function(f) {
    //         if (f.properties['layer'] == 'gi') {
    //              return true;
    //         }
    //         else
    //             return false;
    //     });

        cuspMarkerLayer.on('click', function(e) {
            e.layer.unbindPopup();
            var marker = e.layer;
            var feature = marker.feature;
            // var feature = e.layer.feature;
            console.log(marker);
            console.log(feature);

            var content = '<h3>' + feature.properties.gi + '</h3>' + '<h4>' + feature.properties.title + '</h4>' + feature.properties.description + '<br \/>' + '<a target="_blank" href="' + feature.properties.website + '">' + feature.properties.website + '</a>' + '<br \/>' + '<h4>' + "Source: " + feature.properties.cusp_name + '</h4>' + '<img src="' + feature.properties.photo + '" />';

            marker.bindPopup(content, {
                closeButton: true,
                minWidth: 320
            });
        });
    }

    else {
        var layer = L.mapbox.tileLayer(layerId);
    }

    if(activeStatus == 'active') {
        layer.addTo(map);
        if(interaction) {
            var gridLayer = L.mapbox.gridLayer(layerId);
            map.addLayer(gridLayer);
            map.addControl(L.mapbox.gridControl(gridLayer, {'template': interaction}));
        }
    }

    // Add custom popups to each using our custom feature properties
    if (layerType == 'markers'){
         cuspMarkerLayer.on('click', function(e) {
            e.layer.unbindPopup();
            var feature = e.layer.feature;
            console.log(feature);

            var info = '<h3>' + feature.properties.title + '</h3>' +
                        '<h5>' + "Submitted by: " + feature.properties.cusp_name + '</h5>' +
                       '<h5>' + feature.properties.description + '</h5>';
            if (feature.properties.photo != "") {
                info += '<img src="' + feature.properties.photo + '" />';
            }
            // Reload the Disqus comments on marker click.
            DISQUS.reset({
              reload: true,
              config: function () {
                this.page.identifier = "marker-" + feature.properties.id;
                this.page.url = 'http://cuspmap.org/Pittsburgh.html/' + feature.properties.id + '#!newthread'; // TODO: Create real url to access.
              }
            });

            document.getElementById('markerinfo2').innerHTML = info;
            // Hide the marker adder if it's visible
            formcontainer.className = '';
            // Re-open the sidebar if it's hidden
            body.className = '';
        });

    }

    // else if (layerType == 'adaptation') {
    //     cuspMarkerLayer.on('click', function(e) {
    //         e.layer.unbindPopup();
    //         var marker = e.layer;
    //         var feature = marker.feature;
    //         // var feature = e.layer.feature;
    //         console.log(marker);
    //         console.log(feature);

    //         var content = '<h3>' + feature.properties.gi + '</h3>' + '<h4>' + feature.properties.title + '</h4>' + feature.properties.description + '<br \/>' + '<a target="_blank" href="' + feature.properties.website + '">' + feature.properties.website + '</a>' + '<br \/>' + '<h4>' + "Source: " + feature.properties.cusp_name + '</h4>' + '<img src="' + feature.properties.photo + '" />';

    //         marker.bindPopup(content, {
    //             closeButton: true,
    //             minWidth: 320
    //         });
    //     });
    // }

    // A layer switcher that toggles layers on and off.

    // "item" contains each layer
    var item = document.createElement('li');
    item.className = 'layernamecontainer ' + layerType;
    item.style.display = 'none';
    item.layerType = layerType;
    item.name1 = layerName.id;

   // checkbox to be toggled
    var checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.layerId = layerName.id;
    checkbox.layerType = layerName.layerType;

    // The label contains the name of the layer
    var label = document.createElement('label');
    label.innerHTML = layerName.name;
    if (layerName.title) {
        label.title = layerName.title;
    }

    // The info that describes the layer
    var infobutton = document.createElement('button');
    infobutton.innerHTML = "i";
    if (layerName.title) {
        infobutton.content = layerName.title;
    }

    // Handle the click of the info button
    infobutton.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        popUp(infobutton.content);
    }

    // Handle the change of checkbox state
    checkbox.onchange = function(e) {
        e.preventDefault();
        e.stopPropagation();

        if (map.hasLayer(layer)) {
            map.removeLayer(layer);
            this.className = '';
            if (interaction) {
                map.removeLayer(interaction);
            }

        } else {
            map.addLayer(layer);
            this.className = 'active';
            if (interaction) {
                map.addLayer(interaction);
            }

        }

        // Handle legend open/closed state
        if(legendContainer.style.display == 'block') {
            legendContainer.style.display = 'none';
        }
        else {
            legendContainer.style.display = 'block';
        }

        //Create new list of active checkboxes
        activeCheckboxes.length = 0;
        inactiveCheckboxes.length = 0;
        // insert code to close all subtitles
        getActiveCheckboxes();

        //Send the background layers to the back when switched on or off
        // if(layerType == 'baseMap'){
        //     layer.bringToBack(map);
        // }

    };
    item.appendChild(checkbox);
    item.appendChild(label);
    if (layerName.title) {
        item.appendChild(infobutton);
    }

    // Optionally, create the legend for the layer
    if (layerLegend) {
        var legendContainer = document.createElement('ul');
        legendContainer.className = 'legend';
        for (i = 0; i < layerLegend.length; i++) {
            var legendItem = document.createElement('li');
            var legendColor = document.createElement('span');
            var legendTitle = document.createElement('span');
            legendTitle.innerHTML = layerLegend[i].title;
            legendColor.className = 'keycolor';
            legendItem.className = layerLegend[i].class;
            legendItem.appendChild(legendColor);
            legendItem.appendChild(legendTitle);
            legendContainer.appendChild(legendItem);
        }
        item.appendChild(legendContainer);
    }

    if(activeStatus == 'active') {
        checkbox.checked = true;
        legendContainer.style.display = 'block';
    }

    ui.appendChild(item);
}

// Add custom popups to adaptation layers
function adaptationPopup(layer) {
    layer.on('click', function(e) {
        e.layer.unbindPopup();
        var marker = e.layer;
        var feature = marker.feature;

        var content = '<h3>' + feature.properties.gi + '</h3>' + '<h4>' + feature.properties.title + '</h4>' + '<img style="padding-right:20px; padding-top: 5px; padding-bottom: 5px;" align="left" src="' + feature.properties.photo + '"/>' + feature.properties.description + '<br \/>' + "Source: " + feature.properties.cusp_name + '<br \/>';

        marker.bindPopup(content, {
            closeButton: true,
            minWidth: 520
        });
    });
}

function sameStateAll(state, selectedInputs, selectedCheckboxes) {
    for (var i = 0; i < checkboxes.length; i++) {
        if (state == false) {
            if (checkboxes[i].checked == state) {
                checkboxes[i].checked = state;
                checkboxes[i].className = '';
            }
            else {
                checkboxes[i].checked = state;
                checkboxes[i].className = '';
                 activateOnClick(checkboxes[i], 'change');
            }
        }
    }
}

function activateOnClick(item, actionShortName) {
    if(document.createEventObject) {
        item.fireEvent("on" + actionShortName)
    }
    else {
        var evt = document.createEvent("HTMLEvents");
        evt.initEvent(actionShortName, true, true);
        item.dispatchEvent(evt);
    }
}

function popUp(content){
    var popup = document.createElement('div');
    popup.className = 'popup';
    popup.id = 'test';
    var cancel = document.createElement('div');
    cancel.className = 'cancel';
    cancel.innerHTML = 'X';
    cancel.onclick = function (e) { popup.parentNode.removeChild(popup) };
    var message = document.createElement('span');
    message.innerHTML = content;
    popup.appendChild(message);
    popup.appendChild(cancel);
    document.body.appendChild(popup);
}

</script>

</body>

</html>
